<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>A-Frame PBR 8k texture test</title>
    <meta name="description" content="A-Frame PBR Example" />
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.5.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
    
    <script>
    AFRAME.registerComponent('shadowed-specular-material', {
  schema: {
    color: {type: 'color', default: '#6a7cc4'},
    emissive: {type: 'color', default: '#6a7cc4'},
    emissiveIntensity: {type: 'number', default: 4},
    roughness: {type: 'number', default: 0.1},
    metalness: {type: 'number', default: 0.3}
  },

  init: function () {
    const data = this.data;

    // Basic uniforms setup
    this.uniforms = THREE.UniformsUtils.merge([
      THREE.ShaderLib.standard.uniforms,
      {
        emissiveIntensity: {value: data.emissiveIntensity}
      }
    ]);

    // Override some uniforms with data
    this.uniforms.emissive.value = new THREE.Color(data.emissive);
    this.uniforms.diffuse.value = new THREE.Color(data.color);
    this.uniforms.roughness.value = data.roughness;
    this.uniforms.metalness.value = data.metalness;

    // Vertex shader: use THREE.js standard vertex shader
    const vertexShader = THREE.ShaderLib.standard.vertexShader;

    // Fragment shader: tweak standard shader to multiply emissive by emissiveIntensity
    const fragmentShader = THREE.ShaderLib.standard.fragmentShader.replace(
      '#include <emissivemap_fragment>',
      `
      #include <emissivemap_fragment>
      // Multiply emissive color by intensity
      totalEmissiveRadiance *= emissiveIntensity;
      `
    );

    this.material = new THREE.ShaderMaterial({
      uniforms: this.uniforms,
      vertexShader: vertexShader,
      fragmentShader: fragmentShader,
      lights: true,
      transparent: false,
      defines: THREE.ShaderLib.standard.defines,
      // Enable shadow support
      shadowSide: THREE.FrontSide,
      // These two lines keep standard PBR lighting & shadows working
      extensions: {
        derivatives: true,
        fragDepth: false,
        drawBuffers: false,
        shaderTextureLOD: false
      }
    });

    // Set material to the entityâ€™s mesh
    this.el.getObject3D('mesh').material = this.material;
  }
});

    
    
    </script>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script>
  AFRAME.registerComponent('shadowed-specular-material', {
    schema: {
      src: {type: 'map'},
      normalMap: {type: 'map'},
      roughnessMap: {type: 'map'},
      metalness: {type: 'number', default: 0},
      emissive: {type: 'color', default: '#000000'},
      emissiveIntensity: {type: 'number', default: 1},
      roughness: {type: 'number', default: 0.5},
    },

    init: function () {
      const el = this.el;
      const data = this.data;

      this.material = new THREE.MeshStandardMaterial({
        map: data.src,
        normalMap: data.normalMap,
        roughnessMap: data.roughnessMap,
        metalness: data.metalness,
        emissive: new THREE.Color(data.emissive),
        emissiveIntensity: data.emissiveIntensity,
        roughness: data.roughness,
        // Make sure material casts and receives shadows
        castShadow: true,
        receiveShadow: true,
      });

      // Hook into shader compilation to modify specular term
      this.material.onBeforeCompile = (shader) => {
        // Inject shadowing into specular lighting calculation
        // We'll multiply specular by shadow map visibility for each light

        shader.fragmentShader = shader.fragmentShader.replace(
          '#include <lights_fragment_begin>',
          `
          #include <lights_fragment_begin>

          // We'll override specular to include shadow attenuation from the first shadowed light

          float shadowVisibility = 1.0;

          #ifdef USE_SHADOWMAP
          // Assuming the first shadow map is from the point light that casts shadows
          shadowVisibility = allShadowMaps[0].shadow; // This is pseudocode, see below
          #endif
          `
        );

        // Then multiply specular color by shadowVisibility
        // Find the specular lighting calculation and multiply by shadowVisibility

        shader.fragmentShader = shader.fragmentShader.replace(
          'totalSpecular = vec3(0.0);',
          'totalSpecular = vec3(0.0); // reset'
        );

        shader.fragmentShader = shader.fragmentShader.replace(
          'totalSpecular += specular;',
          'totalSpecular += specular * shadowVisibility;'
        );
      };

      el.getObject3D('mesh').material = this.material;
    },

    update: function () {
      // Update textures if changed dynamically
      if (!this.material) return;
      const data = this.data;
      this.material.map = data.src;
      this.material.normalMap = data.normalMap;
      this.material.roughnessMap = data.roughnessMap;
      this.material.metalness = data.metalness;
      this.material.emissive.set(data.emissive);
      this.material.emissiveIntensity = data.emissiveIntensity;
      this.material.roughness = data.roughness;
      this.material.needsUpdate = true;
    }
  });
</script>

    
    
    
    
    
    
    
  </head>
  <body>
    <a-scene
      shadow="type: basic"
      renderer="colorManagement: true; physicallyCorrectLights: true; shadowMapEnabled: true;"
      background="color: #000"
    >
      <a-assets>
        <img id="skybox1" crossorigin="anonymous"
          src="https://cdn.glitch.global/85d36ce4-fd66-4591-adc8-ae9eb40728ba/ace%20skyboxm.jpg?v=1747916281277" />
        <img id="albedoTex" crossorigin="anonymous"
          src="https://cdn.glitch.global/85d36ce4-fd66-4591-adc8-ae9eb40728ba/Albedo_8Km.jpg?v=1747913373940" />
        <img id="normalTex" crossorigin="anonymous"
          src="https://cdn.glitch.global/85d36ce4-fd66-4591-adc8-ae9eb40728ba/Normal_8Km.jpg?v=1747913356286" />
        <img id="roughTex" crossorigin="anonymous"
          src="https://cdn.glitch.global/85d36ce4-fd66-4591-adc8-ae9eb40728ba/Roughness_8Km.jpg?v=1747913348383" />
      </a-assets>

      <!-- Skybox -->
      <a-sky src="#skybox1" geometry="primitive: sphere; radius: 492.72; segmentsWidth: 12; segmentsHeight: 12"
        scale="0.7 0.4 1"></a-sky>

      <!-- Lights -->
      <a-entity light="type: ambient; intensity: 1.5; color: #6a7cc4"></a-entity>

      <a-entity id="sun"
        light="color: #d17321; intensity: 2.04; castShadow: true; groundColor: #d5c039; penumbra: 2"
        position="10 3 -0.9"></a-entity>

      <!-- Floating orb with light -->
<a-entity id="orb-container" position="0 2 2"
  animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear;">
  
  <a-sphere position="1 0 0" radius="0.2"
    shadow="cast: true"
    shadowed-specular-material="emissive: #6a7cc4; emissiveIntensity: 4; color: #6a7cc4; roughness: 0.1; metalness: 0.3;">
    
    <a-light type="point" color="#6a7cc4" intensity="15" distance="10" decay="2" castShadow="true"
      shadow-camera-near="0.5" shadow-camera-far="50" shadow-map-width="2048" shadow-map-height="2048"
      shadow-bias="-0.001"></a-light>
      
    <!-- directional light pointing at the sphere primitive -->
    <a-entity light="type: directional; color: #6a7cc4; intensity: 0.5; castShadow: true;"
              position="0 0 0"
              look-at="[sphere]"
              shadow-camera-near="0.5"
              shadow-camera-far="50"
              shadow-map-width="4096"
              shadow-map-height="4096"
              shadow-bias="-0.001">
    </a-entity>
    
  </a-sphere>
</a-entity>


      <!-- PLAYER RIG: WASD + Gamepad Locomotion -->
      <a-entity id="rig" movement-controls position="0 0 0">
        <a-entity id="camera" camera position="0 1.6 0" look-controls wasd-controls></a-entity>

        <!-- These two enable VR controller thumbstick movement -->
        <a-entity id="leftHand" tracked-controls="hand: left" gamepad-controls="hand: left"></a-entity>
        <a-entity id="rightHand" tracked-controls="hand: right" gamepad-controls="hand: right"></a-entity>
      </a-entity>

      <!-- Geometry -->
      <a-box position="-2 0.5 -1" width="1" height="1" depth="1"
        material="shader: standard; src: #albedoTex; normalMap: #normalTex; roughnessMap: #roughTex; metalness: 0; repeat: 1 1;"
        shadow="cast: true; receive: true"></a-box>

      <a-sphere id="sphere" position="0 0.5 -3" radius="0.75"
        material="shader: standard; src: #albedoTex; normalMap: #normalTex; roughnessMap: #roughTex; metalness: 0; repeat: 1 1;"
        shadow="cast: true; receive: true"></a-sphere>

      <a-cylinder position="2 0.75 -4.5" radius="0.5" height="1.5"
        material="shader: standard; src: #albedoTex; normalMap: #normalTex; roughnessMap: #roughTex; metalness: 0; repeat: 1 1;"
        shadow="cast: true; receive: true"></a-cylinder>

      <a-plane rotation="-90 0 0" width="30" height="30"
        material="shader: standard; src: #albedoTex; normalMap: #normalTex; roughnessMap: #roughTex; metalness: 0; repeat: 4 4;"
        shadow="cast: true; receive: true"></a-plane>
    </a-scene>
  </body>
</html>
